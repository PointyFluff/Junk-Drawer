- hosts: "*"
# ruby.yml
# install older ruby stack via rvm on ubuntu 14.04
# NOTE: Package install order is very important here. 
# Ubuntu likes to brute force it's own software over RVM install
  vars:
#    ansible_python_interpreter: /usr/bin/python3
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
    ansible_user: deploy
    ansible_port: 774
    ansible_ssh_private_key_file: keys/deploy_id
#    ansible_python_interpreter: /usr/bin/python3
  remote_user: root
  become: yes
  tasks:

    - name: Check server
      ping:

    - name: Update
      apt:
        autoclean: yes
        autoremove: yes
        update_cache: yes
        cache_valid_time: 36000
        force_apt_get: yes
        upgrade: yes
    
    - name: Install packages
      apt:
        autoclean: yes
        autoremove: yes
        force_apt_get: yes
        state: latest
        install_recommends: yes
        name: "{{ item }}"
      with_items:
        - build-essential
        - gnupg
        - zlib1g-dev
        - libssl-dev
        - libpcre3-dev
        - libcurl4-openssl-dev
        - libxml2
        - libxml2-dev
        - libxslt1-dev
        - mysql-client
        - mysql-server
        - libmysqlclient-dev
        - git
        - dirmngr
        - gpgv2 # 14.04
        - apt-transport-https
        - ca-certificates

    - name: Add RVM's GPG Keys
      shell: 'gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB'
      args:
        warn: false

    - name: "Install nodejs"
      shell: "curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -"
    
# ADD USERS TO RVM, UNCOMMENT AND EDIT ITEMS LIST
      # - name: "Add EXISTING users to rvm group"
      #   user:
      #     append: yes
      #     groups: rvm
      #     name: "{{ item }}"
      #   with_items:
      #     - "example_user_a"
      #     - "example_user_b"
      #     - "example_user_etc"

    - name: Install ruby-1.8.7-p374
      shell: 'curl -sSL https://get.rvm.io | bash -s stable --ruby=1.8.7-p374'
      args:
        warn: false
        executable: /bin/bash

    - name: Install gem rake 0.8.4
      gem:
        name: rake
        version: 0.8.4
        include_doc: no
        state: present
        env_shebang: yes
        executable: "/usr/local/rvm/rubies/ruby-1.8.7-p374/bin/gem"
        
    - name: Install gem rails 2.2.2
      gem:
        name: rails
        version: 2.2.2
        include_doc: no
        state: present
    
    - name: Install gem mysql 2.7
      gem:
        name: mysql
        version: 2.7
        include_doc: no
        state: present

    - name: Install gem passenger 2.1.2
      gem:
        name: passenger
        version: 2.1.2
        include_doc: no
        state: present
...